apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: denynodeport
spec:
  crd:
    spec:
      names:
        kind: DenyNodePort
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package admission.denynodeport

        violation[{"msg": msg, "details": {"resource": "Service", "path": "spec.type"}}] {
          not waiver_exempts
          input.review.kind.kind == "Service"
          spec := input.review.object.spec
          spec.type == "NodePort"
          msg := "NodePort services are not allowed. resource=Service path=spec.type"
        }

        violation[{"msg": msg, "details": {"resource": "Service", "port": port, "path": "spec.ports[*].nodePort"}}] {
          not waiver_exempts
          input.review.kind.kind == "Service"
          spec := input.review.object.spec
          ports := spec.ports
          port := ports[_]
          port.nodePort
          msg := sprintf("NodePort services are not allowed. resource=Service port=%v path=spec.ports[*].nodePort", [port.nodePort])
        }

        violation[entry] {
          entry := waiver_violations[_]
        }

        waiver_violations[{"msg": msg, "details": {"resource": input.review.kind.kind, "path": path}}] {
          waiver_enabled
          waiver_reason_missing
          reason_key := waiver_reason_key
          reason_key != ""
          path := sprintf("metadata.annotations[%q]", [reason_key])
          msg := sprintf("Waiver reason annotation %q must be provided whenever %q is set. resource=%s path=%s", [reason_key, waiver_expiry_key, input.review.kind.kind, path])
        }

        waiver_violations[{"msg": msg, "details": {"resource": input.review.kind.kind, "path": path}}] {
          waiver_enabled
          waiver_expiry_parse_error
          path := sprintf("metadata.annotations[%q]", [waiver_expiry_key])
          msg := sprintf("Waiver expiry annotation %q must use YYYY-MM-DD or RFC3339 format. resource=%s path=%s", [waiver_expiry_key, input.review.kind.kind, path])
        }

        waiver_violations[{"msg": msg, "details": {"resource": input.review.kind.kind, "path": path}}] {
          waiver_enabled
          waiver_expired
          waiver_expiry_value(value)
          path := sprintf("metadata.annotations[%q]", [waiver_expiry_key])
          msg := sprintf("Waiver expired on %s; policy enforcement has resumed. resource=%s path=%s", [value, input.review.kind.kind, path])
        }

        waiver_exempts {
          waiver_enabled
          waiver_requested
          waiver_reason_present
          waiver_expiry_ts(ts)
          ts >= time.now_ns()
        }

        waiver_reason_present {
          reason_key := waiver_reason_key
          reason_key == ""
        }

        waiver_reason_present {
          reason_key := waiver_reason_key
          reason_key != ""
          annotations := waiver_annotations
          val := trim_space(object.get(annotations, reason_key, ""))
          val != ""
        }

        waiver_reason_missing {
          waiver_requested
          reason_key := waiver_reason_key
          reason_key != ""
          annotations := waiver_annotations
          val := trim_space(object.get(annotations, reason_key, ""))
          val == ""
        }

        waiver_expiry_parse_error {
          waiver_requested
          waiver_expiry_value(value)
          not parse_waiver_expiry(value, _)
        }

        waiver_expired {
          waiver_expiry_ts(ts)
          ts < time.now_ns()
        }

        waiver_expiry_ts(ts) {
          waiver_expiry_value(value)
          parse_waiver_expiry(value, ts)
        }

        parse_waiver_expiry(value, ts) {
          re_match(`^\d{4}-\d{2}-\d{2}$`, value)
          ts := time.parse_rfc3339_ns(sprintf("%sT23:59:59Z", [value]))
        }

        parse_waiver_expiry(value, ts) {
          re_match(`^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$`, value)
          ts := time.parse_rfc3339_ns(value)
        }

        parse_waiver_expiry(value, ts) {
          re_match(`^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[+-]\d{2}:\d{2}$`, value)
          ts := time.parse_rfc3339_ns(value)
        }

        waiver_expiry_value(value) {
          waiver_requested
          annotations := waiver_annotations
          key := waiver_expiry_key
          raw := object.get(annotations, key, "")
          value := trim_space(raw)
        }

        waiver_requested {
          waiver_enabled
          annotations := waiver_annotations
          key := waiver_expiry_key
          val := trim_space(object.get(annotations, key, ""))
          val != ""
        }

        waiver_annotations = annotations {
          metadata := object.get(input.review.object, "metadata", {})
          annotations := object.get(metadata, "annotations", {})
        }

        waiver_enabled {
          waiver_expiry_key != ""
        }

        waiver_config = object.get(object.get(input, "parameters", {}), "waiver", {})

        waiver_expiry_key = key {
          key := object.get(waiver_config, "expiryAnnotation", "")
        }

        waiver_reason_key = key {
          key := object.get(waiver_config, "reasonAnnotation", "")
        }

        trim_space(val) = trimmed {
          trimmed := trim(val, " \t\r\n")
        }
